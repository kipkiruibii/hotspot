<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WarpSpeed Hotspot - Choose Your Plan</title>
    <style>
      /* General Styles */

      body {
        font-family: Arial, sans-serif;
        background-color: #121212;
        color: white;
        margin: 0;
        padding: 0;
        display: flex;
        width: 100%;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        overflow-x: hidden;
      }

      h1,
      h2 {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #fff;
      }

      /* Header and Logo */
      .header {
        padding: 20px; /* reduce from 40px to allow for more space */
        box-sizing: border-box;
        flex-wrap: wrap;
        background-color: #333;
        display: flex;
        width: 100vw;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .logo img {
        width: 60px;
        height: 60px;
        border-radius: 100%;
      }
      .header h1 {
        font-size: 24px;
        color: #fff;
      }

      /* Plans Container */
      .plans-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        padding: 20px;
        width: 80%;
      }

      /* Individual Plan Style */
      .plan-box {
        background-color: #2c2c2c;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        text-align: center;
        color: white;
        transition: transform 0.3s ease;
      }
      .plan-box:hover {
        transform: scale(1.05);
      }
      .plan-box h2 {
        color: #4caf50;
        font-size: 24px;
      }
      .plan-box p {
        font-size: 18px;
      }
      .plan-btn {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 10px;
      }
      .plan-btn:hover {
        background-color: #0056b3;
      }

      /* Device Selection & Payment */
      #device-selection {
        display: none;
        color: white;
        padding-top: 30px;
        padding-bottom: 30px;
        width: 300px;
      }

      .device-select {
        margin-top: 10px;
        padding: 5px;
        font-size: 16px;
        border-radius: 5px;
        width: 100%;
      }

      .payment-btn {
        margin-top: 20px;
        background-color: #28a745;
        color: white;
        padding: 10px 20px;
        font-size: 18px;
        cursor: pointer;
        border-radius: 5px;
      }

      .payment-btn:hover {
        background-color: #218838;
      }

      .input-container {
        margin-top: 20px;
        text-align: center;
      }

      input[type="text"] {
        padding: 10px;
        font-size: 16px;
        border-radius: 5px;
        width: 80%;
      }

      /* Centering Elements */
      .centered-container {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin-left: 15px;
        margin-right: 15px;
      }

      /* Popup Style */
      .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 100;
        width: 80%;
        max-width: 400px;
        text-align: center;
      }

      .popup button {
        margin-top: 15px;
        padding: 10px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      .popup button:hover {
        background-color: #c82333;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(32, 32, 32, 0.2);
        border-top: 2px solid #ffffff;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive Text & Elements */
      @media (max-width: 768px) {
        .plan-box h2 {
          font-size: 20px;
        }
        .plan-btn {
          font-size: 14px;
        }
        .device-select {
          font-size: 14px;
        }
        .payment-btn {
          font-size: 16px;
        }
      }

      .mpesa-input {
        width: 80%;
        padding: 12px 16px;
        margin: 10px;
        font-size: 16px;
        border: 1.5px solid #ccc;
        border-radius: 8px;
        outline: none;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
      }

      .mpesa-input:focus {
        border-color: #009688; /* Teal tone for M-Pesa feel */
        box-shadow: 0 0 6px rgba(0, 150, 136, 0.3);
      }
    </style>
  </head>
  <body>
    <!-- Header with Logo and Title -->
    <div class="header">
      <div class="logo">
        <img class="ilogo" src="assets/hsp_logo.png" alt="WarpSpeed Logo" />
      </div>
      <h1>WarpSpeed Hotspot</h1>
    </div>

    <!-- Welcome Message -->
    <div class="centered-container">
      <h2>Welcome to WarpSpeed Hotspot</h2>
      <p>
        Choose the perfect plan that suits your needs and enjoy seamless,
        high-speed internet access!
      </p>
      <p>
        WHATSAPP NI
        <strong style="color: rgb(208, 137, 4)">FREE FOREVER.</strong>
      </p>
    </div>

    <!-- Plans Grid -->
    <div class="plans-container">
      <div class="plan-box">
        <h2>Hourly Plan</h2>
        <p>Unlimited - 1 Hour</p>
        <p><strong>Starting from KSh 10</strong></p>
        <button class="plan-btn" onclick="setPlan('hourly', 10)">Select</button>
      </div>
      <div class="plan-box">
        <h2>Daily Plan</h2>
        <p>Unlimited - 1 Day</p>
        <p><strong>Starting from KSh 30</strong></p>
        <button class="plan-btn" onclick="setPlan('daily', 30)">Select</button>
      </div>
      <div class="plan-box">
        <h2>Weekly Plan</h2>
        <p>Unlimited - 1 Week(7 days)</p>
        <p><strong>Starting from KSh 200</strong></p>
        <button class="plan-btn" onclick="setPlan('weekly', 200)">
          Select
        </button>
      </div>
      <div class="plan-box">
        <h2>Monthly Plan</h2>
        <p>Unlimited - 1 Month(30days)</p>
        <p><strong>Starting from KSh 800</strong></p>
        <button class="plan-btn" onclick="setPlan('monthly', 800)">
          Select
        </button>
      </div>
    </div>
    <input type="hidden" name="mac" value="$(mac)" />
    <input type="hidden" name="ip" value="$(ip)" />

    <!-- Device Selection and Payment -->
    <div id="device-selection">
      <p style="color: red">
        ⚠️ Important: Using your phone as a hotspot for other devices will
        reduce your internet speed.
      </p>
      <!-- <h2>Select Number of Devices</h2> -->
      <label for="device-count" style="margin-bottom: 10px"
        >Select Number of Devices:</label
      ><br />
      <select class="device-select" id="device-count" onchange="updateAmount()">
        <option value="1">1 Device</option>
        <option value="2">2 Devices</option>
        <option value="3">3 Devices</option>
        <option value="4">4 Devices</option>
        <option value="5">5 Devices</option>
      </select>
      <p id="total-amount" style="display: none">
        Total Amount: KSh <span id="amount">10</span>
      </p>

      <div class="input-container">
        <label for="mpesa-number" style="margin-bottom: 10px"
          >Enter MPesa Number:</label
        ><br />
        <input
          type="tel"
          id="mpesa-number"
          class="mpesa-input"
          inputmode="numeric"
          pattern="^(07|01)\d{8}$"
          maxlength="10"
          placeholder="Enter MPesa Number eg 0712345678"
        />
      </div>
      <button class="payment-btn" id="payment-btn" onclick="proceedToPayment()">
        Proceed to Pay KSh <span id="final-amount">10</span>
      </button>
    </div>
    <div style="display: flex; justify-content: center">
      <p
        id="message"
        style="display: none; margin-top: 20px; color: rgb(1, 172, 1)"
      ></p>
    </div>
    <div style="display: flex; justify-content: center; margin-bottom: 20px">
      <button
        onclick="copyMessage()"
        style="display: none"
        id="copy-btn"
        class="payment-btn"
      >
        Copy Link
      </button>
    </div>

    <!-- Popup for Missing or Invalid MPesa Number -->
    <div class="popup" id="popup">
      <p>Please enter a valid MPesa number. Ex. 0712345678</p>
      <button onclick="closePopup()">Close</button>
    </div>

    <script>
      let selectedPlan = "";
      let baseAmount = 0;

      // Set the plan and base amount
      function setPlan(plan, amount) {
        selectedPlan = plan;
        baseAmount = amount;
        const deviceSelection = document.getElementById("device-selection");
        deviceSelection.style.display = "block";
        updateAmount();
        deviceSelection.scrollIntoView({ behavior: "smooth" });
      }
      function copyMessage() {
        const text = document.getElementById("message").textContent;

        // Modern method
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(text)
            .then(() => {
              alert("Link copied to clipboard!");
            })
            .catch((err) => {
              fallbackCopyText(text);
            });
        } else {
          fallbackCopyText(text);
        }
      }

      // Fallback method using a temporary textarea
      function fallbackCopyText(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand("copy");
          alert("Link copied to clipboard!");
        } catch (err) {
          alert("Failed to copy text.");
        }
        document.body.removeChild(textarea);
      }

      // Update the amount when the device count changes
      function updateAmount() {
        const deviceCount = document.getElementById("device-count").value;
        const finalAmount = baseAmount * (1 + 0.9 * (deviceCount - 1));
        document.getElementById("amount").innerText = finalAmount.toFixed(2);
        document.getElementById("final-amount").innerText =
          finalAmount.toFixed(2);
      }

      function proceedToPayment() {
        const mpesaNumber = document.getElementById("mpesa-number").value;
        const macAddress = document.querySelector('input[name="mac"]').value;
        const ipAddress = document.querySelector('input[name="ip"]').value;
        const amount = parseFloat(
          document.getElementById("final-amount").innerText
        );
        const button = document.getElementById("payment-btn");
        const message = document.getElementById("message");

        const planType = selectedPlan;
        const devices_count = document.getElementById("device-count").value;
        const mpesaIsValid = /^(07|01)\d{8}$/.test(mpesaNumber);

        if (!mpesaNumber) {
          document.getElementById("popup").style.display = "block";
        } else if (!mpesaIsValid) {
          document.getElementById("popup").style.display = "block";
        } else {
          button.disabled = true;
          button.innerHTML = `<span class="spinner"></span> Processing please wait...`;
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "https://warpspeed.site/initiate_pay", true);
          xhr.setRequestHeader("Content-Type", "application/json");
          xhr.onload = function () {
            if (xhr.status === 200) {
              const data = JSON.parse(xhr.responseText);
              alert(
                "Payment initiated successfully! Enter your mpesa pin in the pop up to complete the payment. Once done refresh the page to get the login link"
              );
              // button.innerHTML = `<span class="spinner"></span> Waiting for Payment...`;
              // button.disabled = false;
              button.style.display = "none";
              message.innerText = `An STK has been sent to ${mpesaNumber}. Enter pin to confirm the payment. Afterwards refresh this page to get login link`;
              message.style.display = "block";
              // button.innerHTML = `Proceed to Pay KSh <span id="final-amount">${amount}</span>`;
            } else {
              // alert("Payment failed.");
              button.disabled = false;
              button.innerHTML = `Proceed to Pay KSh <span id="final-amount">${amount}</span>`;
            }
          };
          xhr.onerror = function () {
            console.error("Network error");
            alert("Payment failed.");
          };

          xhr.send(
            JSON.stringify({
              phone_number: mpesaNumber,
              mac_address: macAddress,
              amount: amount,
              plan_type: planType,
              devices_count: devices_count,
              ip_address: ipAddress,
            })
          );
        }
      }

      // Close the popup
      function closePopup() {
        document.getElementById("popup").style.display = "none";
      }
      document.addEventListener("DOMContentLoaded", function () {
        // Automatically send the MAC address when the page loads
        const macAddress = document.querySelector('input[name="mac"]').value;

        if (macAddress) {
          // Send MAC address to the server to fetch the login link
          fetchLoginLink(macAddress);
        }
      });

      // Function to send the MAC address and get the login link
      function fetchLoginLink(macAddress) {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", "https://warpspeed.site/get_login_link", true);
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onload = function () {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);

            // Assuming the response contains the login link
            if (data && data.login_link) {
              const isSuccessful = data.success;
              if (isSuccessful) {
                const loginLink = data.login_link;
                // You can display the login link wherever you want on the page
                const message = document.getElementById("message");
                const cpy_link = document.getElementById("copy-btn");
                message.innerHTML = `Your login link: <a href="${loginLink}" target="_blank">${loginLink}</a>`;
                message.style.display = "block";
                cpy_link.style.display = "block";
              }
            } else {
              console.error("No login link found in response.");
            }
          } else {
            console.error("Error fetching login link.");
          }
        };

        xhr.onerror = function () {
          console.error("Network error");
        };

        // Send the MAC address to the server
        xhr.send(
          JSON.stringify({
            mac_address: macAddress,
          })
        );
      }
    </script>
  </body>
</html>
